<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ··åˆç›´æ’­</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <style>
      :root{
        --bg: radial-gradient(1200px 800px at 10% -20%, #1a283f 0%, #0b0e14 55%);
        --panel-bg: rgba(22,24,28,.66);
        --panel-border: rgba(255,255,255,.08);
        --elev: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
        --text-1:#e6e7eb; --text-2:#b7bac2; --muted:#8c91a1;
        --accent:#4c8dff; --accent-2:#5fd1ff; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
        --field-bg:#0f1117; --field-bd:rgba(255,255,255,.08);
      }
      html, body { margin: 0; height: 100%; background: var(--bg); overflow-x: hidden; }
      body, input, button { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft Yahei", sans-serif; color: var(--text-1); }
      #app { position: absolute; inset: 0; display: flex; }
      #main { position: relative; flex: 1; }
      #dplayer { position: absolute; inset: 0; }
      /* å°†ä¾§æ æ”¹ä¸ºæ‚¬æµ®è¦†ç›–ï¼Œå¹¶å¯å®Œå…¨è®©å‡ºå¸ƒå±€ç©ºé—´ */
      #sidebar { position: fixed; right: 0; top: 0; bottom: 0; width: 360px; z-index: 5; background: var(--panel-bg); border-left: 1px solid var(--panel-border); display: flex; flex-direction: column; backdrop-filter: blur(12px); box-shadow: var(--elev); transform: translateX(0); transition: transform .2s ease; }
      #sidebar.closed { transform: translateX(100%); }
      /* æ‚¬æµ®æŠ˜å æŒ‰é’®ï¼ˆç‹¬ç«‹äºä¾§æ ï¼Œé˜²æ­¢ä¾§æ å®Œå…¨éšè—åä¸å¯æ‰“å¼€ï¼‰ */
      #sidebarToggle { position: fixed; right: 12px; top: 12px; z-index: 6; height: 36px; width: 36px; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(0,0,0,.35); color: var(--text-1); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--elev); }
      #sidebar.closed ~ #sidebarToggle { right: 12px; }
      .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 14px; border-bottom: 1px solid var(--panel-border); }
      .sidebar-header span { font-weight: 700; color: var(--text-1); letter-spacing: .3px; }
      .sidebar-header button { background: transparent; color: var(--text-1); border: 1px solid var(--panel-border); border-radius: 8px; width: 32px; height: 32px; cursor: pointer; transition: .2s ease; }
      .sidebar-header button:hover { border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.04); }
      .sidebar-content { padding: 12px; overflow: auto; flex: 1; }
      .block { margin-bottom: 14px; padding: 12px; border: 1px solid var(--panel-border); border-radius: 12px; background: rgba(255,255,255,.02); box-shadow: inset 0 1px 0 rgba(255,255,255,.02); }
      .block h3 { margin: 0 0 10px 0; font-size: 13px; color: var(--text-2); font-weight: 700; letter-spacing: .3px; text-transform: uppercase; }
      .form-row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
      .form-row label { font-size: 12px; color: var(--muted); }
      .form-row input { height: 36px; padding: 6px 10px; background: rgba(25,28,35,.85); color: var(--text-1); border: 1px solid rgba(255,255,255,.12); border-radius: 10px; outline: none; transition: .15s ease; }
      .form-row input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(76,141,255,.18); background: rgba(30,34,42,.95); }
      .row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .row input.room { flex: 1; height: 36px; padding: 6px 10px; background: rgba(25,28,35,.85); color: var(--text-1); border: 1px solid rgba(255,255,255,.12); border-radius: 10px; }
      .row input.room:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(76,141,255,.18); background: rgba(30,34,42,.95); }
      .row input.color { width: 40px; height: 36px; padding: 0; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(25,28,35,.85); }
      .row button.remove { width: 36px; height: 36px; border-radius: 10px; background: transparent; color: var(--text-1); border: 1px solid var(--panel-border); cursor: pointer; transition: .2s ease; display:flex; align-items:center; justify-content:center; }
      .row button.remove:hover { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.2); }
      .presets { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
      .presets span { font-size: 12px; color: var(--muted); }
      .preset-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(255,255,255,.7); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,.25); transition: transform .1s ease; }
      .preset-dot:hover { transform: translateY(-1px); }
      .status-row { display:flex; align-items:center; gap:10px; margin:8px 0; padding: 6px 8px; border-radius: 10px; background: rgba(255,255,255,.02); border: 1px solid var(--panel-border); }
      .status-row .light { width:10px; height:10px; border-radius:50%; background:#6c757d; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset; }
      .status-row .light.ok { background:var(--ok); }
      .status-row .light.warn { background:var(--warn); }
      .status-row .light.err { background:var(--danger); }
      .status-text { font-size:12px; color:var(--text-2); }
      .btn { height: 38px; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(255,255,255,.03); color: var(--text-1); padding: 8px 12px; cursor: pointer; transition: .2s ease; }
      .btn:hover { background: rgba(255,255,255,.06); }
      .btn-primary { background: linear-gradient(180deg, var(--accent), #3a7fff); border: none; color: white; box-shadow: 0 6px 16px rgba(76,141,255,.35); }
      .btn-primary:hover { filter: brightness(1.05); }
      .btn-danger { background: linear-gradient(180deg, #ff5a5a, #ef4444); border: none; color: white; box-shadow: 0 6px 16px rgba(239,68,68,.35); }
      .btn-ghost { background: transparent; border: 1px dashed var(--panel-border); }
      .btn-ghost:hover { background: rgba(255,255,255,.04); }
      .btn-block { width: 100%; }
      .actions { display: flex; flex-direction: column; gap: 10px; }
      @media (max-width: 900px) {
        #app { flex-direction: column; }
        #sidebar { width: 100%; right: 0; left: 0; }
        #sidebar.closed { transform: translateY(100%); }
        #sidebarToggle { top: auto; bottom: 12px; }
      }
      /* å‡æ…¢ DPlayer å¼¹å¹•æ»šåŠ¨é€Ÿåº¦ */
      .dplayer .dplayer-danmaku .dplayer-danmaku-move,
      .dplayer .dplayer-danmaku-move { animation-duration: 9s !important; }
    </style>
    <!-- Electron æ¡Œé¢åº”ç”¨æ ·å¼ -->
    <link rel="stylesheet" href="../electron/styles.css">
  </head>
  <body>
    <!-- Electron è‡ªå®šä¹‰æ ‡é¢˜æ  -->
    <div class="electron-titlebar" id="electronTitlebar">
      <div class="title">MultipleLive Desktop Player</div>
      <div class="window-controls">
        <button class="control-btn minimize" id="minimizeBtn" title="æœ€å°åŒ–">âˆ’</button>
        <button class="control-btn maximize" id="maximizeBtn" title="æœ€å¤§åŒ–/è¿˜åŸ">â–¡</button>
        <button class="control-btn close" id="closeBtn" title="å…³é—­">Ã—</button>
      </div>
    </div>
    
    <div id="app">
      <div id="main">
        <div id="dplayer"></div>
      </div>
      <div id="sidebar" class="open">
        <div class="sidebar-header">
          <span>é…ç½®</span>
        </div>
        <div class="sidebar-content">
          <section class="block">
            <h3>ç›´æ’­æº</h3>
            <div class="form-row">
              <label>è§†é¢‘æº</label>
              <input id="videoInput" placeholder="æˆ¿é—´ID/URLæˆ–m3u8"/>
            </div>
            <div class="form-row">
              <label>éŸ³é¢‘æº</label>
              <input id="audioInput" placeholder="æˆ¿é—´ID/URLæˆ–m3u8"/>
            </div>
            <div class="form-row">
              <label>Bç«™ SESSDATAï¼ˆå¯é€‰ï¼Œä»…ç”¨äºåŸç”»ï¼‰</label>
              <div style="display:flex;gap:6px;">
                <input id="sessInput" placeholder="ç•™ç©ºåˆ™å°è¯•è‡ªåŠ¨è·å–" style="flex:1;"/>
                <button id="tryAutoSess" class="btn" style="padding:0 10px;white-space:nowrap;">è‡ªåŠ¨è·å–</button>
              </div>
            </div>
            <div id="sessHint" style="display:none;padding:8px;margin-top:6px;border-radius:8px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);font-size:12px;color:#f59e0b;">
              âš ï¸ æœªæ£€æµ‹åˆ° B ç«™ç™»å½•ï¼Œä»…æ”¯æŒ 480P ç”»è´¨ã€‚è¯·åœ¨<a href="https://live.bilibili.com/" target="_blank" style="color:var(--accent-2);text-decoration:underline;">Bç«™ç›´æ’­</a>ç™»å½•åå†è¯•ï¼Œæˆ–æ‰‹åŠ¨å¡«å†™ SESSDATAã€‚
            </div>
          </section>
          <section class="block">
            <h3>å¼¹å¹•æ¥æºä¸é¢œè‰²</h3>
            <div id="dmSourceList"></div>
            <button id="addSourceBtn" class="btn btn-ghost btn-block" style="margin-top:8px;">
              ï¼‹ æ·»åŠ æ¥æº
            </button>
            <div class="presets">
              <span>é¢„è®¾é¢œè‰²:</span>
              <div class="preset-dot" data-color="#000000" style="background:#000000;"></div>
              <div class="preset-dot" data-color="#007bff" style="background:#007bff;"></div>
              <div class="preset-dot" data-color="#ff3b30" style="background:#ff3b30;"></div>
              <div class="preset-dot" data-color="#28a745" style="background:#28a745;"></div>
              <div class="preset-dot" data-color="#ffcc00" style="background:#ffcc00;"></div>
            </div>
          </section>
          <section class="block">
            <h3>è¿è¡ŒçŠ¶æ€</h3>
            <div class="status-row"><span>è§†é¢‘</span><div id="lightVideo" class="light"></div><span id="textVideo" class="status-text">æœªå¯åŠ¨</span></div>
            <div class="status-row"><span>éŸ³é¢‘</span><div id="lightAudio" class="light"></div><span id="textAudio" class="status-text">æœªå¯åŠ¨</span></div>
            <div class="status-row"><span>å¼¹å¹•</span><div id="lightDM" class="light"></div><span id="textDM" class="status-text">æœªè¿æ¥</span></div>
          </section>
          <section class="block">
            <h3>éŸ³é‡æ§åˆ¶</h3>
            <div class="form-row">
              <label>éŸ³é¢‘æµéŸ³é‡ <span id="audioVolLabel">100%</span></label>
              <input id="audioVolSlider" type="range" min="0" max="100" value="100" style="height:auto;padding:0;"/>
            </div>
          </section>
          <section class="block">
            <h3>åŒæ­¥æ§åˆ¶</h3>
            <div style="font-size:12px;color:var(--text-2);margin-bottom:10px;">
              <div>è§†é¢‘å»¶è¿Ÿ: <span id="videoDelayText" style="color:var(--accent-2);">--</span></div>
              <div>éŸ³é¢‘å»¶è¿Ÿ: <span id="audioDelayText" style="color:var(--accent-2);">--</span></div>
              <div>å·®å€¼: <span id="diffDelayText" style="font-weight:600;">--</span></div>
            </div>
            <div class="form-row">
              <label>è§†é¢‘æ—¶é—´åç§» <span id="offsetLabel">0.0s</span></label>
              <input id="offsetSlider" type="range" min="-100" max="100" value="0" step="1" style="height:auto;padding:0;"/>
            </div>
            <button id="autoAlignBtn" class="btn btn-block" style="margin-top:8px;">æ‰‹åŠ¨åˆ·æ–°</button>
          </section>
          
          <button id="applyBtn" class="btn btn-primary btn-block" style="margin-bottom:10px;">å¼€å§‹</button>
          <button id="stopBtn" class="btn btn-danger btn-block" style="display:none;margin-bottom:10px;">åœæ­¢</button>
        </div>
      </div>
      <button id="sidebarToggle" title="æ”¶èµ·/å±•å¼€">â‰¡</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <script>
      // Electron çª—å£æ§åˆ¶
      if (typeof window.electronAPI !== 'undefined') {
        document.addEventListener('DOMContentLoaded', () => {
          // çª—å£æ§åˆ¶æŒ‰é’®äº‹ä»¶
          document.getElementById('minimizeBtn').addEventListener('click', () => {
            window.electronAPI.minimizeWindow();
          });
          
          document.getElementById('maximizeBtn').addEventListener('click', () => {
            window.electronAPI.maximizeWindow();
          });
          
          document.getElementById('closeBtn').addEventListener('click', () => {
            window.electronAPI.closeWindow();
          });
          
          // é”®ç›˜å¿«æ·é”®
          document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
              switch (e.key) {
                case 't':
                  e.preventDefault();
                  window.electronAPI.toggleAlwaysOnTop();
                  break;
                case 'm':
                  e.preventDefault();
                  window.electronAPI.minimizeWindow();
                  break;
              }
            }
            if (e.key === 'F11') {
              e.preventDefault();
              window.electronAPI.toggleFullscreen();
            }
          });
        });
      }
      
      const m3u8Url = new URLSearchParams(location.search).get('src') || '/out/mixed/playlist.m3u8';
       const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/danmaku';
      const hexToInt = (hex) => {
        try {
          const s = String(hex || '#ffffff').replace('#', '');
          const n = parseInt(s, 16);
          return Number.isFinite(n) ? n : 0xffffff;
        } catch { return 0xffffff; }
      };

      // è¿è¡ŒçŠ¶æ€ä¸UIæ§åˆ¶
      let isRunning = false;
      let isActivePlayback = true;
      let lastPausedAt = 0;
      function setActivePlayback(on) {
        isActivePlayback = !!on;
        if (isActivePlayback) {
          try { dp.danmaku.clear(); } catch {}
        }
      }
      function setRunning(on) {
        isRunning = !!on;
        const videoInput = document.getElementById('videoInput');
        const audioInput = document.getElementById('audioInput');
        const dmSourceList = document.getElementById('dmSourceList');
        const addSourceBtn = document.getElementById('addSourceBtn');
        const applyBtn = document.getElementById('applyBtn');
        const stopBtn = document.getElementById('stopBtn');
        if (videoInput) videoInput.disabled = isRunning;
        if (audioInput) audioInput.disabled = isRunning;
        if (addSourceBtn) addSourceBtn.disabled = isRunning;
        if (dmSourceList) {
          dmSourceList.querySelectorAll('input,button.remove').forEach(el => { el.disabled = isRunning; });
        }
        if (applyBtn) applyBtn.style.display = isRunning ? 'none' : 'inline-block';
        if (stopBtn) stopBtn.style.display = isRunning ? 'inline-block' : 'none';
        // é¢„è®¾é¢œè‰²ç¦ç”¨ç‚¹å‡»
        document.querySelectorAll('.preset-dot').forEach(dot => {
          dot.style.pointerEvents = isRunning ? 'none' : 'auto';
          dot.style.opacity = isRunning ? '0.6' : '1';
        });
      }
      function setVideoStatus(kind) {
        const light = document.getElementById('lightVideo');
        const text = document.getElementById('textVideo');
        if (!light || !text) return;
        light.className = 'light';
        if (kind === 'ok') { light.classList.add('ok'); text.textContent = 'è·å–ä¸­'; }
        else if (kind === 'warn') { light.classList.add('warn'); text.textContent = 'é‡è¿ä¸­'; }
        else if (kind === 'err') { light.classList.add('err'); text.textContent = 'å¼‚å¸¸'; }
        else { text.textContent = 'æœªå¯åŠ¨'; }
      }
      function setAudioStatus(kind) {
        const light = document.getElementById('lightAudio');
        const text = document.getElementById('textAudio');
        if (!light || !text) return;
        light.className = 'light';
        if (kind === 'ok') { light.classList.add('ok'); text.textContent = 'è·å–ä¸­'; }
        else if (kind === 'warn') { light.classList.add('warn'); text.textContent = 'é‡è¿ä¸­'; }
        else if (kind === 'err') { light.classList.add('err'); text.textContent = 'å¼‚å¸¸'; }
        else { text.textContent = 'æœªå¯åŠ¨'; }
      }
      function setDMStatus(kind) {
        const light = document.getElementById('lightDM');
        const text = document.getElementById('textDM');
        if (!light || !text) return;
        light.className = 'light';
        if (kind === 'ok') { light.classList.add('ok'); text.textContent = 'å·²è¿æ¥'; }
        else if (kind === 'warn') { light.classList.add('warn'); text.textContent = 'é‡è¿ä¸­'; }
        else if (kind === 'err') { light.classList.add('err'); text.textContent = 'å¼‚å¸¸'; }
        else { text.textContent = 'æœªè¿æ¥'; }
      }

       const dp = new DPlayer({
        container: document.getElementById('dplayer'),
        live: true,
        danmaku: true,
        apiBackend: {
          read: function (options) {
            // ç›´æ’­æ¨¡å¼ä¸ä»åç«¯è¯»å–å†å²å¼¹å¹•ï¼Œç›´æ¥è¿”å›ç©º
            options.success([]);
          },
          send: function (options) {
            // ç¦æ­¢ç”¨æˆ·å‘é€å¼¹å¹•ï¼ˆåªè§‚çœ‹ï¼‰
            console.log('Send disabled in live mode');
            options.success();
          },
        },
        video: { url: m3u8Url, type: 'hls' },
      });
      try { dp.danmaku.show(); dp.danmaku.opacity(0.9); } catch {}

      // å–æ¶ˆè‡ªåŠ¨è¿½å¸§ï¼šä¸å†åœ¨æ’­æ”¾æ—¶å¼ºåˆ¶è·³åˆ°æœ€æ–°ç‚¹

      // ç›‘å¬ DPlayer æ’­æ”¾/æš‚åœï¼ŒåŒæ­¥éŸ³é¢‘å…ƒç´ 
      try {
        dp.video.addEventListener('pause', () => {
          try { if (audioEl) { audioEl.pause(); setAudioStatus('warn'); } } catch {}
          lastPausedAt = Date.now();
          setActivePlayback(false);
        });
        dp.video.addEventListener('play', () => {
          try {
            if (audioEl) {
              audioEl.play().catch(() => {});
              setAudioStatus('ok');
            }
          } catch {}
          // å¦‚æœæš‚åœæ—¶é—´è¾ƒé•¿ï¼Œæ¸…ç†ç§¯å‹å¼¹å¹•åå†ç»§ç»­
          if (Date.now() - lastPausedAt > 1000) {
            setActivePlayback(true);
          } else {
            isActivePlayback = true;
          }
        });
      } catch {}

      // æ ‡ç­¾å¯è§æ€§å˜åŒ–ï¼šéšè—æ—¶æ ‡è®°ä¸ºéæ´»åŠ¨ï¼Œä¸¢å¼ƒå¼¹å¹•ï¼›æ¢å¤æ—¶æ¸…ç©ºå†å²
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          setActivePlayback(false);
        } else {
          setActivePlayback(true);
        }
      });

       // éšè—çš„éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆDPlayer æˆ–åŸç”Ÿ <audio> + hlsï¼‰
      let audioDp = null; // å¯é€‰çš„ç¬¬äºŒä¸ª DPlayerï¼ˆéšè—ï¼‰
      let audioHls = null; // åŸç”ŸéŸ³é¢‘å…ƒç´ çš„ hls.js å®ä¾‹
      let hls = null; // è§†é¢‘ hls.js å®ä¾‹
      let lastFragAt = 0;
      let lastAudioFragAt = 0;
       let audioEl = null;  // åŸç”ŸéŸ³é¢‘å…ƒç´ 

      // HLS æ”¯æŒ
      const WARN_GRACE_MS = 6000;
      function initVideoHls(srcUrl) {
        if (!Hls.isSupported()) return null;
        const conf = {
          maxBufferLength: 30,
          maxMaxBufferLength: 120,
          liveSyncDuration: 6,
          liveMaxLatencyDuration: 20,
          backBufferLength: 20,
          liveBackBufferLength: 12,
        };
        const inst = new Hls(conf);
        inst.loadSource(srcUrl);
        inst.attachMedia(dp.video);
        inst.on(Hls.Events.MANIFEST_PARSED, () => { if (isRunning) { lastFragAt = Date.now(); setVideoStatus('ok'); } });
        inst.on(Hls.Events.FRAG_LOADED,     () => { if (isRunning) { lastFragAt = Date.now(); setVideoStatus('ok'); } });
        inst.on(Hls.Events.ERROR, (_e, data) => {
          if (!isRunning) return;
          if (data && data.fatal) { setVideoStatus('err'); return; }
          if (Date.now() - lastFragAt > WARN_GRACE_MS) setVideoStatus('warn');
        });
        return inst;
      }

      // åŠ¨æ€æ³¨å…¥å¼¹å¹•ï¼ˆé€šè¿‡WSå®æ—¶æ¥æ”¶ï¼‰
      // DPlayer æä¾› dp.danmaku.draw æ¥å£ï¼›è‹¥ä¸å¯ç”¨ï¼Œåˆ™ä½¿ç”¨ send æ³¨å…¥åˆ°æœ¬åœ°æ± 
      let ws;
      function connectWS() {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => { if (isRunning) setDMStatus('ok'); };
        ws.onmessage = (ev) => {
          try {
            if (!isActivePlayback) return; // ä¸¢å¼ƒéæ´»åŠ¨æœŸé—´çš„å¼¹å¹•ï¼Œé¿å…ç§¯å‹
            const data = JSON.parse(ev.data);
            const text = data.msg || '';
            const colorHex = data.color || '#ffffff';
            // ç›´æ¥ä½¿ç”¨ dp.danmaku.draw() ç»˜åˆ¶å¼¹å¹•ï¼ˆDPlayer ç›´æ’­æ¨èæ–¹å¼ï¼‰
            if (dp.danmaku && typeof dp.danmaku.draw === 'function') {
              const danmaku = { text, color: colorHex, type: 'right' };
              dp.danmaku.draw(danmaku);
            }
            if (isRunning) setDMStatus('ok');
          } catch {}
        };
        ws.onerror = () => { if (isRunning) setDMStatus('err'); };
        ws.onclose = () => { if (isRunning) setDMStatus('warn'); setTimeout(connectWS, 1000); };
      }
      connectWS();

      // ä¾§æ é€»è¾‘ä¸é…ç½®äº¤äº’
      const $ = (id) => document.getElementById(id);
      const sidebar = $('sidebar');
      const toggleBtn = $('sidebarToggle');
      toggleBtn.onclick = () => {
        const closed = sidebar.classList.toggle('closed');
        toggleBtn.textContent = closed ? 'â˜°' : 'âœ•';
      };

      // å°è¯•è‡ªåŠ¨è·å– SESSDATAï¼šåˆ©ç”¨ç¬¬ä¸‰æ–¹ iframe æˆ–æç¤ºç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
      const tryAutoSessBtn = $('tryAutoSess');
      const sessInput = $('sessInput');
      const sessHint = $('sessHint');
      async function autoFetchSess() {
        // æµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼šæ— æ³•ç›´æ¥è¯»å–ç¬¬ä¸‰æ–¹ Cookieï¼ˆbilibili.comï¼‰ï¼Œåªèƒ½é€šè¿‡ä»¥ä¸‹é€”å¾„ï¼š
        // 1. ç”¨æˆ·å·²åœ¨å½“å‰æµè§ˆå™¨ç™»å½• B ç«™ä¸”æ‰“å¼€æœ¬åœ°é¡µé¢ï¼Œå°è¯•é€šè¿‡éšè— iframe åŠ è½½ B ç«™é¡µé¢å¹¶ä» postMessage æ¥æ”¶
        // 2. æµè§ˆå™¨æ‰©å±•/ç”¨æˆ·è„šæœ¬ï¼ˆTampermonkeyï¼‰æ³¨å…¥ä»£ç ï¼Œä» B ç«™é¡µé¢ç›´æ¥è¯»å– document.cookie
        // 3. ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶ï¼ˆå½“å‰é»˜è®¤ï¼‰
        // è¿™é‡Œå®ç°æ–¹æ¡ˆ1çš„ç®€åŒ–ç‰ˆï¼šæ£€æµ‹ localStorage æ˜¯å¦å·²ç¼“å­˜ï¼Œæˆ–æç¤ºç”¨æˆ·å‰å¾€ B ç«™
        let cached = (localStorage.getItem('bili_sessdata') || '').trim();
        if (cached) {
          sessInput.value = cached;
          sessHint.style.display = 'none';
          return;
        }
        // å°è¯•é€šè¿‡éšè— iframe + postMessageï¼ˆéœ€åœ¨ B ç«™é¡µé¢æ³¨å…¥é…åˆè„šæœ¬ï¼Œè¿™é‡Œå…ˆæç¤ºï¼‰
        sessHint.style.display = 'block';
        alert('è‡ªåŠ¨è·å–éœ€è¦ï¼š\n1. åœ¨æµè§ˆå™¨å·²ç™»å½• B ç«™è´¦å·ï¼›\n2. æ‰“å¼€ https://live.bilibili.com/ å¹¶åœ¨æ§åˆ¶å°è¿è¡Œï¼š\n\nlocalStorage.setItem("bili_sessdata", document.cookie.match(/SESSDATA=([^;]+)/)?.[1] || "");\n\nç„¶ååˆ·æ–°æœ¬é¡µé¢å³å¯è‡ªåŠ¨è¯»å–ã€‚\n\næˆ–ç›´æ¥æ‰‹åŠ¨å¡«å†™ SESSDATAã€‚');
      }
      tryAutoSessBtn.onclick = autoFetchSess;
      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è¯»å–ç¼“å­˜
      try {
        const cached = (localStorage.getItem('bili_sessdata') || '').trim();
        if (cached) {
          sessInput.value = cached;
        } else {
          sessHint.style.display = 'block';
        }
      } catch {}

      // éŸ³é¢‘éŸ³é‡æ§åˆ¶
      const audioVolSlider = $('audioVolSlider');
      const audioVolLabel = $('audioVolLabel');
      audioVolSlider.oninput = () => {
        const vol = parseInt(audioVolSlider.value || '100', 10);
        audioVolLabel.textContent = vol + '%';
        if (audioEl) {
          audioEl.volume = vol / 100.0;
        }
      };

      // å»¶è¿Ÿç›‘æ§ä¸åŒæ­¥æ§åˆ¶
      const videoDelayText = $('videoDelayText');
      const audioDelayText = $('audioDelayText');
      const diffDelayText = $('diffDelayText');
      const offsetSlider = $('offsetSlider');
      const offsetLabel = $('offsetLabel');
      const autoAlignBtn = $('autoAlignBtn');
      let cumulativeOffset = 0; // ç´¯ç§¯åç§»é‡

      function getDelay(media) {
        if (!media) return null;
        try {
          const s = media.seekable;
          if (s && s.length > 0) {
            const liveEdge = s.end(s.length - 1);
            const current = media.currentTime || 0;
            return liveEdge - current;
          }
        } catch {}
        return null;
      }

      function updateDelayDisplay() {
        if (!isRunning) {
          videoDelayText.textContent = '--';
          audioDelayText.textContent = '--';
          diffDelayText.textContent = '--';
          return;
        }
        const vDelay = getDelay(dp.video);
        const aDelay = getDelay(audioEl);
        
        videoDelayText.textContent = vDelay !== null ? vDelay.toFixed(1) + 's' : '--';
        audioDelayText.textContent = aDelay !== null ? aDelay.toFixed(1) + 's' : '--';
        
        if (vDelay !== null && aDelay !== null) {
          const diff = aDelay - vDelay; // æ­£å€¼=éŸ³é¢‘è¶…å‰ï¼Œè´Ÿå€¼=éŸ³é¢‘æ»å
          const absDiff = Math.abs(diff);
          let color = 'var(--ok)';
          if (absDiff > 2.0) color = 'var(--danger)';
          else if (absDiff > 0.5) color = 'var(--warn)';
          diffDelayText.style.color = color;
          diffDelayText.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + 's';
        } else {
          diffDelayText.textContent = '--';
        }
      }

      offsetSlider.oninput = () => {
        const val = parseInt(offsetSlider.value || '0', 10);
        const offsetSec = val / 10.0; // -10.0 ~ +10.0
        offsetLabel.textContent = (offsetSec >= 0 ? '+' : '') + offsetSec.toFixed(1) + 's';
        if (dp.video && isRunning) {
          try {
            const delta = offsetSec - cumulativeOffset;
            dp.video.currentTime += delta;
            cumulativeOffset = offsetSec;
          } catch {}
        }
      };

      autoAlignBtn.onclick = () => {
        if (!isRunning || !audioEl || !dp.video) return;
        try {
          // å¼ºåˆ¶è·³è½¬åˆ°æœ€æ–°ç‰‡æ®µ - è§†é¢‘
          if (hls) {
            hls.startLoad(); // é‡æ–°å¼€å§‹åŠ è½½æœ€æ–°æ’­æ”¾åˆ—è¡¨
            // è·³è½¬åˆ°æœ€æ–°å¯æ’­æ”¾ä½ç½®
            if (dp.video.duration && !isNaN(dp.video.duration)) {
              dp.video.currentTime = dp.video.duration - 1; // è·³è½¬åˆ°æœ€æ–°ä½ç½®
            }
          }
          
          // å¼ºåˆ¶è·³è½¬åˆ°æœ€æ–°ç‰‡æ®µ - éŸ³é¢‘
          if (audioHls) {
            audioHls.startLoad(); // é‡æ–°å¼€å§‹åŠ è½½æœ€æ–°æ’­æ”¾åˆ—è¡¨
            // è·³è½¬åˆ°æœ€æ–°å¯æ’­æ”¾ä½ç½®
            if (audioEl.duration && !isNaN(audioEl.duration)) {
              audioEl.currentTime = audioEl.duration - 1; // è·³è½¬åˆ°æœ€æ–°ä½ç½®
            }
          } else if (audioEl.src) {
            // å¯¹äºåŸç”ŸéŸ³é¢‘å…ƒç´ ï¼Œé‡æ–°åŠ è½½æº
            const currentSrc = audioEl.src;
            audioEl.src = '';
            audioEl.load();
            audioEl.src = currentSrc;
            audioEl.play().catch(() => {});
          }
          
          // é‡ç½®æ»‘å—ä¸ç´¯ç§¯åç§»
          offsetSlider.value = '0';
          offsetLabel.textContent = '0.0s';
          cumulativeOffset = 0;
        } catch {}
      };

      // å‘¨æœŸæ›´æ–°å»¶è¿Ÿæ˜¾ç¤º
      setInterval(updateDelayDisplay, 1000);

      const dmSourceList = $('dmSourceList');
      const addSourceBtn = $('addSourceBtn');
      let activeColorInput = null;
      function addSourceRow(room = '', color = '#ffffff') {
        const row = document.createElement('div');
        row.className = 'row';
         row.innerHTML = `
           <input class="room" placeholder="æˆ¿é—´ID/URL" value="${room.replace(/"/g, '&quot;')}">
           <input class="color" type="color" value="${color}">
           <button class="remove" title="åˆ é™¤">ğŸ—‘</button>
         `;
        const roomInput = row.querySelector('input.room');
        const colorInput = row.querySelector('input.color');
        const removeBtn = row.querySelector('button.remove');
        colorInput.addEventListener('focus', () => { activeColorInput = colorInput; });
        roomInput.addEventListener('focus', () => { activeColorInput = colorInput; });
        removeBtn.onclick = () => { dmSourceList.removeChild(row); };
        dmSourceList.appendChild(row);
      }
      function getSources() {
        const rows = Array.from(dmSourceList.querySelectorAll('.row'));
        return rows.map(r => ({
          room: (r.querySelector('input.room').value || '').trim(),
          color: (r.querySelector('input.color').value || '#ffffff').trim(),
        })).filter(x => x.room.length > 0);
      }
      addSourceBtn.onclick = () => addSourceRow('', '#ffffff');
      // åˆå§‹ç»™ä¸€è¡Œ
      addSourceRow('', '#ffffff');

      // é¢„è®¾é¢œè‰²ç‚¹é€‰ï¼šä½œç”¨äºæœ€è¿‘æ¿€æ´»çš„é¢œè‰²è¾“å…¥ï¼›è‹¥æ— ï¼Œä½œç”¨äºæœ€åä¸€è¡Œ
      document.querySelectorAll('.preset-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          if (isRunning) return;
          const c = dot.getAttribute('data-color');
          if (activeColorInput) {
            activeColorInput.value = c;
          } else {
            const last = dmSourceList.querySelector('input.color:last-of-type');
            if (last) last.value = c;
          }
        });
      });

      // åº”ç”¨é…ç½® -> åç«¯ API
       $('applyBtn').onclick = async () => {
        const audio = ($('audioInput').value || '').trim();
        const video = ($('videoInput').value || '').trim();
        const frontMix = true; // å›ºå®šå‰ç«¯ç›´è¿
        const srcs = getSources();
        // å…ˆè§£ææ‰€æœ‰å¼¹å¹•æˆ¿é—´ä¸ºçœŸå®IDï¼Œå†æ„é€  colors æ˜ å°„
        const resolveRoomOnly = async (source) => {
          try {
            const res = await fetch('/api/resolve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ source }) });
            const j = await res.json();
            if (j.ok && j.room_id) return j.room_id;
          } catch {}
          return null;
        };
        const roomsResolved = [];
        const colors = {};
        for (const s of srcs) {
          const rid = await resolveRoomOnly(s.room);
          if (rid) {
            roomsResolved.push(rid);
            colors[rid] = s.color || '#ffffff';
          }
        }
        const rooms = roomsResolved;
        // ä¸´æ—¶ä¿å­˜ SESSDATA åˆ° localStorageï¼Œä¾¿äºè§£ææ—¶æºå¸¦
        try {
          const sess = (document.getElementById('sessInput').value || '').trim();
          if (sess) localStorage.setItem('bili_sessdata', sess);
        } catch {}
        try {
          const isLow = true; // å›ºå®šå‚æ•°
          if (frontMix) {
             // å‰ç«¯ç›´è¿ï¼šåˆ†åˆ«è§£æä¸¤è·¯ m3u8ï¼Œç„¶åï¼šè§†é¢‘æ’­æ”¾å™¨é™éŸ³=falseï¼ŒéŸ³é¢‘æ’­æ”¾å™¨åªæ’­æ”¾éŸ³é¢‘ä¸”éšè—ç”»é¢
             const resolve = async (source) => {
               // å¯ä» localStorage è¯»å– SESSDATA ä»¥è¯·æ±‚åŸç”»
               const sessdata = (localStorage.getItem('bili_sessdata') || '').trim();
               const res = await fetch('/api/resolve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ source, sessdata }) });
               const j = await res.json();
               if (!j.ok) throw new Error(j.error || 'resolve failed');
               return j.url;
             };
             const vUrl = await resolve(video);
             const aUrl = await resolve(audio);
             // åˆ‡ä¸»æ’­æ”¾å™¨
             try {
              if (hls) { try { hls.destroy(); } catch {} hls = null; }
              hls = initVideoHls(vUrl);
              dp.video.muted = true; // åªç”¨ä½œç”»é¢
              try {
                dp.video.addEventListener('playing', () => { if (isRunning) setVideoStatus('ok'); });
                dp.video.addEventListener('waiting', () => { if (isRunning) setVideoStatus('warn'); });
                dp.video.addEventListener('error',   () => { if (isRunning) setVideoStatus('err'); });
              } catch {}
             } catch {}

             // å‡†å¤‡éšè—éŸ³é¢‘æ’­æ”¾å™¨
             try {
               if (!audioEl) {
                 audioEl = document.createElement('audio');
                 audioEl.style.display = 'none';
                 document.body.appendChild(audioEl);
               }
              if (audioHls) { try { audioHls.destroy(); } catch {} audioHls = null; }
              if (!audioEl.canPlayType('application/vnd.apple.mpegurl') && Hls.isSupported()) {
                audioHls = new Hls({ maxBufferLength: 30, liveSyncDuration: 6, liveMaxLatencyDuration: 20, maxMaxBufferLength: 120, backBufferLength: 20, liveBackBufferLength: 12 });
                audioHls.loadSource(aUrl);
                audioHls.attachMedia(audioEl);
                audioHls.on(Hls.Events.MANIFEST_PARSED, () => { if (isRunning) { lastAudioFragAt = Date.now(); setAudioStatus('ok'); } });
                audioHls.on(Hls.Events.FRAG_LOADED,     () => { if (isRunning) { lastAudioFragAt = Date.now(); setAudioStatus('ok'); } });
                audioHls.on(Hls.Events.ERROR, (_e, data) => {
                  if (!isRunning) return;
                  if (data && data.fatal) { setAudioStatus('err'); return; }
                  if (Date.now() - lastAudioFragAt > WARN_GRACE_MS) setAudioStatus('warn');
                });
              } else {
                audioEl.src = aUrl;
                audioEl.addEventListener('playing', () => { if (isRunning) setAudioStatus('ok'); });
                audioEl.addEventListener('waiting', () => { if (isRunning) setAudioStatus('warn'); });
                audioEl.addEventListener('error',   () => { if (isRunning) setAudioStatus('err'); });
              }
               audioEl.muted = false;
               await audioEl.play().catch(()=>{});
             } catch {}
           }
          const r2 = await fetch('/api/danmaku/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rooms, colors }) });
          if (!r2.ok) throw new Error('dm start failed');
          await r2.json();
          setRunning(true);
          setVideoStatus('warn'); setAudioStatus('warn');
          setDMStatus('warn');
          // å›ºå®šå‰ç«¯æ¨¡å¼ï¼Œæ— éœ€åç»­åˆ‡æ¢
          try { if (dp && dp.play) dp.play(); } catch {}
        } catch (e) {
          alert('å¯åŠ¨å¤±è´¥: ' + (e && e.message ? e.message : e));
        }
      };

      // å–æ¶ˆè‡ªæ¸²æŸ“å¼¹å¹•ï¼Œç»Ÿä¸€ä½¿ç”¨ DPlayer å¼¹å¹•

      // åœæ­¢ï¼šè°ƒç”¨åç«¯ /api/stop å¹¶æ¢å¤è¡¨å•
       document.getElementById('stopBtn').onclick = async () => {
        try {
          const r = await fetch('/api/stop', { method: 'POST' });
          if (!r.ok) throw new Error('stop failed');
        } catch (e) {
          // å¿½ç•¥é”™è¯¯ï¼Œä»ç„¶æœ¬åœ°å¤ä½
        }
         try { if (audioHls) { audioHls.destroy(); audioHls = null; } } catch {}
         try {
           if (audioEl) {
             audioEl.pause();
             audioEl.removeAttribute('src');
             audioEl.load?.();
             audioEl.remove();
             audioEl = null;
           }
         } catch {}
         setAudioStatus();
         try {
           // åŒæ­¥åœæ­¢ä¸»æ’­æ”¾å™¨
           if (hls) { try { hls.destroy(); } catch {} hls = null; }
           if (dp && dp.video) {
             dp.pause?.();
             dp.video.pause();
             dp.video.removeAttribute('src');
             try { dp.video.load(); } catch {}
           }
         } catch {}
        setRunning(false);
        setVideoStatus();
        setDMStatus();
        try { if (ws && ws.readyState === WebSocket.OPEN) ws.close(); } catch {}
      };
    </script>
  </body>
  </html>


