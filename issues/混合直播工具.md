# 混合直播工具 - 实施记录

## 目标
- 分离多路直播音/视频并混合输出（音源与画源可来自不同房间）。
- 多房间弹幕采集与颜色区分，叠加在网页播放器上。

## 模块与文件
- 解析器增强：`bili_live_parser.py`
  - `get_live_streams(room_id)` 返回候选；`pick_best_hls(room_id)` 选最优HLS；含重试与回退。
- FFmpeg 混流：`mixer/ffmpeg_mixer.py`
  - `FFmpegMixer`/`start_mix()`：`-map 0:v:0 -map 1:a:0`，默认HLS输出 `out/mixed/playlist.m3u8`，低延迟参数、自动重启。
- 弹幕采集：`danmaku/collector.py`
  - `DanmakuCollector` 多房间连接，颜色映射；产出 `DanmakuItem` 到队列。
- Web 播放与叠加：`web/index.html`
  - `hls.js` 播放 HLS；WS `/ws/danmaku` 收弹幕，Canvas 滚动绘制。
- 服务端：`server.py`（aiohttp）
  - `POST /api/mix` 启动混流；`POST /api/danmaku/start` 启动弹幕；`GET /ws/danmaku` 广播；静态 `/out/mixed/`。
- CLI：`cli.py`
  - 串联 API；`--audio/--video` 支持房间URL/ID或m3u8，`--colors` 指定颜色，`--open` 打开页面。

## 使用
1. 安装依赖（需 `ffmpeg` 在 PATH）：
   - Python 包：`pip install requests pyperclip aiohttp`
   - 或参考 `blivedm/requirements.txt` 安装 aiohttp 等。
2. 启动服务：`python server.py`（默认 127.0.0.1:8090）
3. 启动混流与弹幕：
   - `python cli.py --audio 直播间A --video 直播间B --rooms 直播间A 直播间B --colors 直播间A=#FF5F5F 直播间B=#5F95FF --open`
4. 浏览器访问：`http://127.0.0.1:8090/`（自动播放 `out/mixed/playlist.m3u8` 并叠加弹幕）

## 备注与调优
- 不同CDN与编解码可能导致A/V不同步，可开启 `transcode_video=True` 降低不确定性。
- 低延迟：HLS切片时长 `hls_time=2`，`-fflags nobuffer`，可按网络情况调整。
- 断流自动重试：FFmpeg 子进程自动重启；解析器 HTTP 带重试与指数退避。


